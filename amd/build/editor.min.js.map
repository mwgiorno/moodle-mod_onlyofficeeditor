{"version":3,"file":"editor.min.js","sources":["../src/editor.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module mod_onlyofficeeditor/editor\n * @copyright  2022 Ascensio System SIA <integration@onlyoffice.com>\n * @copyright  based on work by 2018 Olumuyiwa Taiwo <muyi.taiwo@logicexpertise.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n **/\ndefine(['jquery'], function($) {\n    var displayNotification = function(error, type) {\n        require(['core/notification'], function(notification) {\n            require(['core/str'], function(str) {\n                var errorIsAvailable = str.get_string(error, 'onlyofficeeditor');\n                $.when(errorIsAvailable).done(function(localizedStr) {\n                    notification.addNotification({\n                        message: localizedStr,\n                        type: type\n                    });\n                });\n            });\n        });\n    };\n\n    var createFullScreenButtons = function() {\n        require(['core/str'], function(str) {\n            var enterFullScreenText = str.get_string('editorenterfullscreen', 'onlyofficeeditor');\n            var exitFullScreenText = str.get_string('editorexitfullscreen', 'onlyofficeeditor');\n            var navLeftButton = $('.drawertoggle')[1];\n            var navRightButton = $('.drawertoggle')[2];\n            var editorContainer = $('.onlyofficeeditor-container')[0];\n\n            $.when(enterFullScreenText).done(function(localized) {\n                enterFullScreenText = localized;\n                var enterButton = document.createElement('button');\n                var enterIcon = document.createElement('i');\n                enterIcon.className = 'icon fa fa-expand fa-fw';\n                enterButton.appendChild(enterIcon);\n                enterButton.className = 'onlyofficeeditor-editor-fs-button';\n                enterButton.id = 'onlyofficeeditor-enter-fs-button';\n                enterButton.innerHTML += enterFullScreenText;\n\n                enterButton.onclick = function() {\n                    $('header').hide();\n                    $('footer').hide();\n                    if (navLeftButton && navLeftButton.getAttribute('data-aria-hidden-tab-index') === null) {\n                        $(navLeftButton).click();\n                    }\n                    if (navRightButton && navRightButton.getAttribute('data-aria-hidden-tab-index') === null) {\n                        $(navRightButton).click();\n                    }\n                    if ($('.editmode-switch-form').length > 0 && $('.editmode-switch-form')[0][0].checked) {\n                        $(editorContainer).addClass('onlyofficeeditor-rightindent');\n                    }\n                    $(editorContainer).addClass('onlyofficeeditor-fullscreen');\n                    editorContainer.children[0].style.height = '93vh';\n                    $('#onlyofficeeditor-enter-fs-button').hide();\n                    $('#onlyofficeeditor-exit-fs-button').show();\n                };\n                editorContainer.before(enterButton);\n            });\n            $.when(exitFullScreenText).done(function(localized) {\n                exitFullScreenText = localized;\n                var exitButton = document.createElement('button');\n                var exitIcon = document.createElement('i');\n                exitIcon.className = 'icon fa fa-compress fa-fw';\n                exitButton.appendChild(exitIcon);\n                exitButton.innerHTML += exitFullScreenText;\n                exitButton.className = 'onlyofficeeditor-editor-fs-button';\n                exitButton.id = 'onlyofficeeditor-exit-fs-button';\n\n                exitButton.onclick = function() {\n                    $(editorContainer).removeClass('onlyofficeeditor-fullscreen');\n                    $(editorContainer).removeClass('onlyofficeeditor-rightindent');\n                    editorContainer.children[0].style.height = '95vh';\n                    $('header').show();\n                    $('footer').show();\n                    $('#onlyofficeeditor-enter-fs-button').show();\n                    $('#onlyofficeeditor-exit-fs-button').hide();\n                };\n                $('#usernavigation')[0].prepend(exitButton);\n                $('#onlyofficeeditor-exit-fs-button').hide();\n            });\n        });\n    };\n\n    $.urlParam = function(name) {\n        var results = new RegExp('[\\\\?&]' + name + '=([^&#]*)').exec(window.location.href);\n        if (results === null) {\n            return null;\n        }\n        return decodeURI(results[1]) || 0;\n    };\n\n    var replaceActionLink = function(href, linkParam) {\n        var link;\n        var actionIndex = href.indexOf(\"&actionType=\");\n        if (actionIndex != -1) {\n            link = href.substring(0, actionIndex) + \"&actionType=\" + encodeURIComponent(linkParam.type) +\n                \"&actionData=\" + encodeURIComponent(linkParam.data);\n        } else {\n            link = href + \"&actionType=\" + encodeURIComponent(linkParam.type) + \"&actionData=\" + encodeURIComponent(linkParam.data);\n        }\n        return link;\n    };\n\n    var saveAsModal = null;\n\n    var displaySaveAsModal = function(saveAsData, cmid, courseid) {\n        require(['jquery', 'core/templates', 'core/modal_factory', 'mod_onlyofficeeditor/modal_saveas'],\n            function($, Templates, ModalFactory, ModalSaveas) {\n                var trigger = $('.onlyofficeeditor-container');\n                if (saveAsModal === null) {\n                    saveAsModal = ModalFactory.create({\n                        type: ModalSaveas.TYPE\n                    }, trigger);\n                }\n                saveAsModal.done((modal) => {\n                    modal.courseid = courseid;\n                    modal.CMID = cmid;\n                    modal.saveAsData = saveAsData;\n                    modal.renderSections(modal.getBody(), cmid, courseid);\n                    modal.show();\n                });\n            });\n    };\n\n    return {\n        init: function(courseid, cmid) {\n            if (typeof DocsAPI === \"undefined\") {\n                displayNotification('docserverunreachable', 'error');\n                return;\n            }\n            createFullScreenButtons();\n            var ajaxUrl = M.cfg.wwwroot + '/mod/onlyofficeeditor/dsconfig.php';\n            $.getJSON(ajaxUrl, {\n                courseid: courseid,\n                cmid: cmid,\n                actionType: $.urlParam('actionType'),\n                actionData: $.urlParam('actionData')\n            }).done(function(data) {\n                var docEditor = null;\n                var config = data.config;\n\n                var favicon = config.documentType;\n                if (config.fileType === 'docxf' || config.fileType === 'oform') {\n                    favicon = config.fileType;\n                }\n                document.head.innerHTML += '<link type=\"image/x-icon\" rel=\"icon\" href=\"/mod/onlyofficeeditor/pix/'\n                    + favicon + '.ico\" />';\n\n                var canAddInstance = data.addinstance;\n\n                const innerAlert = (message, inEditor) => {\n                    // eslint-disable-next-line no-console\n                    if (console && console.log) {\n                        // eslint-disable-next-line no-console\n                        console.log(message);\n                    }\n                    if (inEditor && docEditor) {\n                        docEditor.showMessage(message);\n                    }\n                };\n\n                var onMakeActionLink = function(event) {\n                    var actionData = event.data.action;\n                    docEditor.setActionLink(replaceActionLink(location.href, actionData));\n                };\n\n                var onRequestSendNotify = function(event) {\n                    var comment = event.data.message;\n                    var emails = event.data.emails;\n                    var replacedActionLink = replaceActionLink(location.href, event.data.actionLink.action);\n\n                    var mentionData = {\n                        comment: comment,\n                        emails: emails,\n                        link: replacedActionLink,\n                        courseid: courseid\n                    };\n\n                    $.ajax(M.cfg.wwwroot + '/mod/onlyofficeeditor/onlyofficeeditorapi.php?apiType=mention&cmid=' + cmid, {\n                        type: 'POST',\n                        dataType: 'json',\n                        data: mentionData\n                    }).fail(() => {\n                        displayNotification('onmentionerror', 'error');\n                    });\n                };\n\n                const onAppReady = () => {\n                    innerAlert(\"Document editor ready\");\n                };\n\n                const onError = (event) => {\n                    if (event) {\n                        innerAlert(event.data);\n                    }\n                };\n                config.events = {\n                    'onAppReady': onAppReady,\n                    'onError': onError,\n                    'onMakeActionLink': onMakeActionLink\n                };\n\n                var onRequestSaveAs = function(event) {\n                    var saveAsData = {\n                        title: event.data.title,\n                        url: event.data.url,\n                        courseid: courseid,\n                        section: null\n                    };\n                    displaySaveAsModal(saveAsData, cmid, courseid);\n                };\n\n                if (canAddInstance) {\n                    config.events.onRequestSaveAs = onRequestSaveAs;\n                }\n\n                var usersToMention = data.userstomention;\n\n                var onRequestUsers = function() {\n                    docEditor.setUsers({'users': usersToMention});\n                };\n\n                if (usersToMention !== null) {\n                    config.events.onRequestUsers = onRequestUsers;\n                    config.events.onRequestSendNotify = onRequestSendNotify;\n                }\n\n                if ((config.document.fileType === \"docxf\" || config.document.fileType === \"oform\")\n                    // eslint-disable-next-line no-undef\n                    && DocsAPI.DocEditor.version().split(\".\")[0] < 7) {\n                    displayNotification('oldversion', 'error');\n                } else {\n                    // eslint-disable-next-line no-undef\n                    docEditor = new DocsAPI.DocEditor(\"onlyofficeeditor-editor\", config);\n                }\n            });\n        }\n    };\n});\n"],"names":["define","$","displayNotification","error","type","require","notification","str","errorIsAvailable","get_string","when","done","localizedStr","addNotification","message","urlParam","name","results","RegExp","exec","window","location","href","decodeURI","replaceActionLink","linkParam","actionIndex","indexOf","substring","encodeURIComponent","data","saveAsModal","init","courseid","cmid","DocsAPI","enterFullScreenText","exitFullScreenText","navLeftButton","navRightButton","editorContainer","localized","enterButton","document","createElement","enterIcon","className","appendChild","id","innerHTML","onclick","hide","getAttribute","click","length","checked","addClass","children","style","height","show","before","exitButton","exitIcon","removeClass","prepend","ajaxUrl","M","cfg","wwwroot","getJSON","actionType","actionData","docEditor","config","favicon","documentType","fileType","head","canAddInstance","addinstance","innerAlert","inEditor","console","log","showMessage","events","event","action","setActionLink","onRequestSaveAs","saveAsData","Templates","ModalFactory","ModalSaveas","trigger","create","TYPE","modal","CMID","renderSections","getBody","displaySaveAsModal","title","url","section","usersToMention","userstomention","onRequestUsers","setUsers","onRequestSendNotify","mentionData","comment","emails","link","actionLink","ajax","dataType","fail","DocEditor","version","split"],"mappings":"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"}